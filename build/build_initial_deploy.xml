<project name="init" default="help"
         basedir=".."
         xmlns:sf="antlib:com.salesforce"
         xmlns:ml="org.missinglink.ant.task.http.HttpClientTask">

    <target name="help" description="default">
        <echo message="Tasks to run for the initial deploy to a Dev org"/>
    </target>

    <!--
        Deploy just the settings needed in order to deploy the app
    -->
    <target name="preDeploy" description="Deploy settings needed for the initial deploy to run successfully">
        <echo level="info">Deploy settings needed for the initial source deploy to: ${sf.target.username} to run successfully</echo>
        <delete dir="${basedir}/pre_deploy"/>
        <mkdir dir="${basedir}/pre_deploy/settings"/>
        <copy file="${basedir}/src/settings/Name.settings" tofile="${basedir}/pre_deploy/settings/Name.settings" encoding="UTF-8"/>
        <echo level="info">Deploying Name settings to: ${sf.target.username}</echo>
        <echo file="${basedir}/pre_deploy/package.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
    <types>
        <members>Name</members>
        <name>Settings</name>
    </types>
        <version>39.0</version>
</Package>]]></echo>
        <sf:deploy
            username="${sf.target.username}"
            password="${sf.target.password}"
            serverurl="${sf.target.serverurl}"
            deployRoot="${basedir}/pre_deploy"
            pollWaitMillis="${sf.pollWaitMillis}"
            maxPoll="${sf.maxPoll}"
            testLevel="NoTestRun"
            logType="Debugonly"/>
        <delete dir="${basedir}/pre_deploy"/>
    </target>

    <target name="turnOffHistoryTracking">
        <echo message="Turn off history tracking in all objects"/>
        <replace dir="${basedir}/src/objects">
            <replacetoken><![CDATA[<trackHistory>true</trackHistory>]]></replacetoken>
            <replacevalue><![CDATA[<trackHistory>false</trackHistory>]]></replacevalue>
            <include name="*.object"/>
        </replace>
    </target>

    <!-- Remove the sharing rules from the source tree & the references to them from package.xml -->
    <target name="removeSharingRules">
        <echo message="Remove sharingRules"/>
        <move todir="${basedir}/src/sharingRules" includeemptydirs="false">
            <fileset dir="${basedir}/src/sharingRules">
                <exclude name="**/*.bak"/>
            </fileset>
            <mapper type="glob" from="*" to="*.bak"/>
        </move>
        <replace file="${basedir}/src/package.xml" encoding="UTF-8">
            <replacetoken><![CDATA[    <types>
        <members>Case.*</members>
        <members>Contact.*</members>
        <members>Coverage__c.Coverage_Sirono_Internal</members>
        <members>Payment_Adjustments__c.PaymentAdj_Sirono_Internal</members>
        <members>Payment_Method__c.Credit_Card_Sirono_Internal</members>
        <members>Payment__c.Payment_Internal_Sirono</members>
        <name>SharingOwnerRule</name>
    </types>
    <types>
        <members>Case</members>
        <members>Contact</members>
        <members>Coverage__c</members>
        <members>Payment__c</members>
        <members>Payment_Adjustments__c</members>
        <members>Payment_Method__c</members>
        <name>SharingRules</name>
    </types>]]></replacetoken>
            <replacevalue><![CDATA[]]></replacevalue>
        </replace>
    </target>

    <target name="deactivateAndDeleteFlows" depends="checkDeactivateAndDeleteFlows" if="flows.present">
        <!-- NOTE: This is required to allow us to ignore deployment errors if the flows aren't present in the target org yet -->
        <subant buildpath="${basedir}/build"
                antfile="build_initial_deploy.xml"
                target="deactivateAndDeleteFlowsIgnoreErrors"
                inheritall="true"
                failonerror="false"/>
    </target>

    <target name="checkDeactivateAndDeleteFlows">
        <condition property="flows.present">
            <resourcecount when="greater" count="0">
                <fileset dir="${basedir}/build/deactivateAndDeleteFlows" includes="**/*.flowDefinition"/>
            </resourcecount>
        </condition>
    </target>

    <!-- TODO: Make this dynamic based on the flows found under src -->
    <target name="deactivateAndDeleteFlowsIgnoreErrors">
        <echo level="info">Deactivate and remove flows from: ${sf.target.username}</echo>
        <sf:deploy
            username="${sf.target.username}"
            password="${sf.target.password}"
            serverurl="${sf.target.serverurl}"
            deployRoot="${basedir}/build/deactivateAndDeleteFlows"
            testLevel="NoTestRun"
            ignoreWarnings="true"/>
    </target>

    <target name="processTemplates" depends="createSites, createSironoNamedCreds"/>

    <target name="createSites">
        <mkdir dir="${basedir}/src/sites"/>
        <copy todir="${basedir}/src/sites" overwrite="true" encoding="UTF-8">
            <fileset dir="${basedir}/template/sites"/>
        </copy>

        <echo message="Make ${sf.siteAdmin} admin for all sites"/>
        <replace dir="${basedir}/src/sites" token="@SITE_ADMIN@" value="${sf.siteAdmin}" encoding="UTF-8">
            <include name="*.site"/>
        </replace>

        <echo message="Set subdomain for all community sites to: ${sf.commSubDomain}"/>
        <replace dir="${basedir}/src/sites" token="@SITE_SUBDOMAIN@" value="${sf.commSubDomain}" encoding="UTF-8">
            <include name="Guarantor_Portal.site"/>
        </replace>
    </target>

    <target name="createSironoNamedCreds">
        <mkdir dir="${basedir}/src/namedCredentials"/>
        <copy todir="${basedir}/src/namedCredentials" overwrite="true" encoding="UTF-8">
            <fileset dir="${basedir}/template/namedCredentials"/>
        </copy>

        <echo message="Set ${sirono.endpoint} as the Sirono_Server NamedCredential endpoint"/>
        <replace dir="${basedir}/src/namedCredentials" token="@ENDPOINT@" value="${sirono.endpoint}" encoding="UTF-8">
            <include name="sirono_server.namedCredential"/>
        </replace>

        <echo message="Set username and password for Sirono_Server NamedCredential"/>
        <replace dir="${basedir}/src/namedCredentials" token="@USERNAME@" value="${sirono.user}" encoding="UTF-8">
            <include name="sirono_server.namedCredential"/>
        </replace>
        <replace dir="${basedir}/src/namedCredentials" token="@PASSWORD@" value="${sirono.pw}" encoding="UTF-8">
            <include name="sirono_server.namedCredential"/>
        </replace>
    </target>

    <!--
        We can't deploy the sharing rules or deploy objects with history tracking turned on until the objects
        that they reference are deployed. Turn off history tracking across the board & hide the sharing rules
    -->
    <target name="deployPrep" description="Prep source for initial deployment to a dev org">
        <echo level="info">Perform prep on source in order to deploy to: ${sf.target.username}</echo>
        <antcall target="turnOffHistoryTracking"/>
        <antcall target="removeSharingRules"/>
    </target>

    <!--
        Use git to revert the sweeping history tracking changes we made.
        Remove the backup copies of the sharing rules
    -->
    <target name="revertPrep">
        <echo message="Revert all changes made in deployPrep"/>
        <exec dir="${basedir}/src/objects" executable="git">
            <arg value="checkout"/>
            <arg value="--"/>
            <arg value="${basedir}/src"/>
        </exec>
        <exec dir="${basedir}/src/sharingRules" executable="git">
            <arg value="checkout"/>
            <arg value="--"/>
            <arg value="${basedir}/src"/>
        </exec>
        <delete>
            <fileset dir="${basedir}/src" includes="**/*.bak"/>
        </delete>
    </target>

    <scriptdef name="getOrgName" language="javascript">
        <attribute name="text"/>
        <attribute name="property"/>
        <![CDATA[
       var str = attributes.get("text");
       var end = str.indexOf("+");
       project.setProperty(attributes.get("property"), str.substring(0, end));
     ]]>
    </scriptdef>

    <target name="testGetOrgName">
        <getOrgName text="${sf.target.username}" property="testorgName"/>
        <echo message="testorgName = ${testorgName}"/>
    </target>
</project>
