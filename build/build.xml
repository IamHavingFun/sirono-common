<!--
  ~ Copyright (c) 2017-present Sirono LLC, All rights reserved
  -->

<project name="SironoAll" default="deployCheckOnly"
         xmlns:sf="antlib:com.salesforce"
         xmlns:ml="org.missinglink.ant.task.http.HttpClientTask"
         basedir="..">

    <property name="libdir" value="${basedir}/build/lib"/>
    <property file="${basedir}/build/build.properties"/>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties"
             classpath="${libdir}/ant-contrib-1.0b3.jar"/>
    <taskdef uri="antlib:com.salesforce"
             resource="com/salesforce/antlib.xml"
             classpath="${libdir}/ant-salesforce.jar"/>
    <taskdef name="http" uri="org.missinglink.ant.task.http.HttpClientTask"
             classname="org.missinglink.ant.task.http.HttpClientTask"
             classpath="${libdir}/ml-ant-http-1.1.3.jar"/>

    <import file="build-common.xml"/>
    <property name="deployRoot" value="${workDir}"/>

    <target name="help">
        <echo message="Targets to run to test/deploy the full suite"/>
    </target>

    <!-- Check only; don't save to the server -->
    <target name="deployCheckOnly" depends="setSingleOrgConnectionProperties, processTemplates, populateUberWorkSrcDir">
        <echo level="info">Validating in: ${sf.target.username} with test level: ${sf.testLevel}</echo>
        <sf:deploy
            username="${sf.target.username}"
            password="${sf.target.password}"
            serverurl="${sf.target.serverurl}"
            deployRoot="${deployRoot}/src"
            pollWaitMillis="${sf.pollWaitMillis}"
            maxPoll="${sf.maxPoll}"
            testLevel="${sf.testLevel}"
            logType="Debugonly"
            ignoreWarnings="true"
            checkOnly="true"/>
    </target>

    <!-- Check only; only run specified tests -->
    <target name="deployCheckSelectTests" depends="setSingleOrgConnectionProperties, processTemplates, populateUberWorkSrcDir">
        <echo level="info">Running select tests in: ${sf.target.username}</echo>
        <sf:deploy
            username="${sf.target.username}"
            password="${sf.target.password}"
            serverurl="${sf.target.serverurl}"
            deployRoot="${deployRoot}/src"
            pollWaitMillis="${sf.pollWaitMillis}"
            maxPoll="${sf.maxPoll}"
            logType="Debugonly"
            checkOnly="true"
            testLevel="RunSpecifiedTests">
            <!-- TODO: Make this use a property so that the build file doesn't have to be modified -->
            <runTest>WorkWithStatementsControllerTest</runTest>
        </sf:deploy>
    </target>

    <target name="populateUberWorkSrcDir">
        <mkdir dir="${workDir}"/>
        <delete dir="${workDir}/src" failonerror="false" quiet="true"/>
        <mkdir dir="${workDir}/src"/>
        <copy todir="${workDir}/src">
            <fileset dir="${basedir}/call-center/src" includes="**/*" excludes="**/staticresources/*,**/contentassets/*,**/documents/**/*,labels/CustomLabels.labels,package.xml"/>
            <fileset dir="${basedir}/call-center/post_install/src" includes="**/*" excludes="**/staticresources/*,**/contentassets/*,**/documents/**/*,package.xml"/>
            <fileset dir="${basedir}/portal/src" includes="**/*" excludes="**/staticresources/*,**/contentassets/*,**/documents/**/*,labels/CustomLabels.labels,package.xml"/>
            <fileset dir="${basedir}/portal/post_install/src" includes="**/*" excludes="**/staticresources/*,**/contentassets/*,**/documents/**/*,package.xml"/>
            <fileset dir="${basedir}/adapter-Five9/src" includes="**/*" excludes="**/staticresources/*,**/contentassets/*,**/documents/**/*,package.xml"/>
            <filterchain>
                <!-- Change official namespace qualifications to development namespace qualifications before deployment -->
                <replaceregex pattern="\b(${sf.sprs.official.namespace})(\.|__|:)" replace="${sf.sprs.development.namespace}\2" flags="gi"/>
                <replaceregex pattern="\b(${sf.spfp.official.namespace})(\.|__|:)" replace="${sf.spfp.development.namespace}\2" flags="gi"/>
            </filterchain>
        </copy>
        <!-- Copy custom labels renaming for uniqueness -->
        <mkdir dir="${workDir}/src/labels"/>
        <copy file="${basedir}/call-center/src/labels/CustomLabels.labels" tofile="${workDir}/src/labels/CallCenterLabels.labels"/>
        <copy file="${basedir}/portal/src/labels/CustomLabels.labels" tofile="${workDir}/src/labels/PortalLabels.labels"/>
        <!-- Copy binary files without performing any replacements -->
        <copy todir="${workDir}/src">
            <fileset dir="${basedir}/call-center/src" includes="**/staticresources/*,**/contentassets/*,**/documents/**/*"/>
            <fileset dir="${basedir}/call-center/post_install/src" includes="**/staticresources/*,**/contentassets/*,**/documents/**/*"/>
            <fileset dir="${basedir}/portal/src" includes="**/staticresources/*,**/contentassets/*,**/documents/**/*"/>
            <fileset dir="${basedir}/portal/post_install/src" includes="**/staticresources/*,**/contentassets/*,**/documents/**/*"/>
            <fileset dir="${basedir}/adapter-Five9/src" includes="**/staticresources/*,**/contentassets/*,**/documents/**/*"/>
        </copy>

        <echo message="Build uber package.xml"/>
        <copy file="${basedir}/call-center/src/package.xml" tofile="${workDir}/src/call-center-package.xyz">
            <filterchain>
                <filterreader classname="org.apache.tools.ant.filters.HeadFilter">
                    <param name="lines" value="-1"/>
                    <!-- NOTE: Need to skip more here because of the packaging elements -->
                    <param name="skip" value="3"/>
                </filterreader>
                <filterreader classname="org.apache.tools.ant.filters.TailFilter">
                    <param name="lines" value="-1"/>
                    <param name="skip" value="2"/>
                </filterreader>
            </filterchain>
        </copy>
        <copy file="${basedir}/call-center/post_install/src/package.xml" tofile="${workDir}/src/call-center-post_install.xyz">
            <filterchain>
                <filterreader classname="org.apache.tools.ant.filters.HeadFilter">
                    <param name="lines" value="-1"/>
                    <param name="skip" value="2"/>
                </filterreader>
                <filterreader classname="org.apache.tools.ant.filters.TailFilter">
                    <param name="lines" value="-1"/>
                    <param name="skip" value="2"/>
                </filterreader>
            </filterchain>
        </copy>
        <copy file="${basedir}/portal/src/package.xml" tofile="${workDir}/src/portal-package.xyz">
            <filterchain>
                <filterreader classname="org.apache.tools.ant.filters.HeadFilter">
                    <param name="lines" value="-1"/>
                    <!-- NOTE: Need to skip more here because of the packaging elements -->
                    <param name="skip" value="3"/>
                </filterreader>
                <filterreader classname="org.apache.tools.ant.filters.TailFilter">
                    <param name="lines" value="-1"/>
                    <param name="skip" value="2"/>
                </filterreader>
            </filterchain>
        </copy>
        <copy file="${basedir}/portal/post_install/src/package.xml" tofile="${workDir}/src/portal-post_install.xyz">
            <filterchain>
                <filterreader classname="org.apache.tools.ant.filters.HeadFilter">
                    <param name="lines" value="-1"/>
                    <param name="skip" value="2"/>
                </filterreader>
                <filterreader classname="org.apache.tools.ant.filters.TailFilter">
                    <param name="lines" value="-1"/>
                    <param name="skip" value="2"/>
                </filterreader>
            </filterchain>
        </copy>
        <copy file="${basedir}/adapter-Five9/src/package.xml" tofile="${workDir}/src/adapter-Five9-package.xyz">
            <filterchain>
                <filterreader classname="org.apache.tools.ant.filters.HeadFilter">
                    <param name="lines" value="-1"/>
                    <!-- NOTE: Need to skip more here because of the packaging elements -->
                    <param name="skip" value="3"/>
                </filterreader>
                <filterreader classname="org.apache.tools.ant.filters.TailFilter">
                    <param name="lines" value="-1"/>
                    <param name="skip" value="2"/>
                </filterreader>
            </filterchain>
        </copy>

        <concat destfile="${workDir}/src/package.xml" force="yes">
            <fileset dir="${workDir}/src" includes="*.xyz"/>
            <header><![CDATA[<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
    <fullName>Sirono PRS</fullName>]]>
            </header>
            <footer><![CDATA[<version>40.0</version>
</Package>]]>
            </footer>
        </concat>
        <delete>
            <fileset dir="${workDir}/src" includes="*.xyz"/>
        </delete>
    </target>

    <target name="processTemplates">
        <echo level="info">processTemplates in: ${ant.project.name}</echo>
    </target>

    <!-- Composite targets for dev efficiency -->

    <!--
     - TODO: For single-org dev, create a target like the check-only target above that deploys everything at once.
     - TODO: Note that this would bypass local packages, but that's probably okay.
     -->

    <target name="deployNoTests" description="Deploys metadata for all modules without running unit tests">
        <ant dir="call-center/build" antfile="build.xml" target="deployNoTests" inheritall="false" usenativebasedir="true"/>
        <ant dir="portal/build" antfile="build.xml" target="deployNoTests" inheritall="false" usenativebasedir="true"/>
        <ant dir="adapter-Five9/build" antfile="build.xml" target="deployNoTests" inheritall="false" usenativebasedir="true"/>
    </target>

    <target name="deployPostInstall" description="Deploys post-install metadata for all modules">
        <ant dir="call-center/build" antfile="build.xml" target="deployPostInstall" inheritall="false" usenativebasedir="true"/>
        <ant dir="portal/build" antfile="build.xml" target="deployPostInstall" inheritall="false" usenativebasedir="true"/>
    </target>

    <target name="undeployCode" description="Undeploys obsolete metadata for all modules without running unit tests">
        <ant dir="call-center/build" antfile="build.xml" target="undeployCode" inheritall="false" usenativebasedir="true"/>
        <ant dir="portal/build" antfile="build.xml" target="undeployCode" inheritall="false" usenativebasedir="true"/>
        <ant dir="adapter-Five9/build" antfile="build.xml" target="undeployCode" inheritall="false" usenativebasedir="true"/>
    </target>

</project>