<project name="Retrieve and Deploy SFDC metadata" default="deployCheckOnly"
         basedir=".." xmlns:sf="antlib:com.salesforce">

    <taskdef uri="antlib:com.salesforce"
             resource="com/salesforce/antlib.xml"
             classpath="${basedir}/build/ant-salesforce.jar"/>

    <property file="${basedir}/build/build.properties"/>
    <property environment="env"/>
    <property name="retrieve_target" value="${basedir}/sf_temp"/>

    <!-- Setting default value for username & password properties to empty string
         so unset values are treated as empty. Without this, ant expressions such as ${sf.blah.username}
         will be treated literally.
    -->
    <condition property="sf.target.username" value="">
        <not>
            <isset property="sf.target.username"/>
        </not>
    </condition>
    <condition property="sf.target.password" value="">
        <not>
            <isset property="sf.target.password"/>
        </not>
    </condition>
    <condition property="sf.pollWaitMillis" value="100000">
        <not>
            <isset property="sf.pollWaitMillis"/>
        </not>
    </condition>
    <condition property="sf.maxPoll" value="100">
        <not>
            <isset property="sf.maxPoll"/>
        </not>
    </condition>

    <target name="retrieve">
        <echo level="info">Retrieving from: ${sf.source.username}</echo>
        <mkdir dir="${retrieve_target}"/>
        <sf:retrieve
                retrieveTarget="${retrieve_target}"
                username="${sf.source.username}"
                password="${sf.source.password}"
                serverurl="${sf.source.serverurl}"
                unpackaged="${basedir}/src/package.xml"/>
        <move file="${retrieve_target}" tofile="${basedir}/src"/>
    </target>

    <target name="deploy">
        <echo level="info">Deploying to: ${sf.target.username}</echo>
        <sf:deploy
                username="${sf.target.username}"
                password="${sf.target.password}"
                serverurl="${sf.target.serverurl}"
                deployRoot="${basedir}/src"
                pollWaitMillis="${sf.pollWaitMillis}"
                maxPoll="${sf.maxPoll}"
                testLevel="RunLocalTests"
                logType="Debugonly"/>
    </target>

    <target name="undeployCode" depends="echo_environment">
        <echo level="info">Remove metadata from: ${sf.target.username}</echo>
        <sf:deploy
                username="${sf.target.username}"
                password="${sf.target.password}"
                serverurl="${sf.target.serverurl}"
                deployRoot="${basedir}/build/undeploy"
                ignoreWarnings="true"/>
    </target>

    <!-- Check only; don't save to the server -->
    <target name="deployCheckOnly">
        <echo level="info">Validating in: ${sf.target.username}</echo>
        <sf:deploy
                username="${sf.target.username}"
                password="${sf.target.password}"
                serverurl="${sf.target.serverurl}"
                deployRoot="${basedir}/src"
                pollWaitMillis="${sf.pollWaitMillis}"
                maxPoll="${sf.maxPoll}"
                testLevel="RunLocalTests"
                logType="Debugonly"
                checkOnly="true"/>
    </target>

    <target name="echo_environment">
        <echoproperties prefix="sf."/>
        <echoproperties prefix="env."/>
    </target>
</project>
