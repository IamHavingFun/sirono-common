<!--
  ~ Copyright (c) 2017-present Sirono LLC, All rights reserved
  -->

<project name="init" default="help"
         xmlns:sf="antlib:com.salesforce"
         xmlns:ml="org.missinglink.ant.task.http.HttpClientTask">

    <target name="help">
        <echo message="Tasks to run for the initial deploy to a Dev org"/>
    </target>

    <!--
        Deploy just the settings needed in order to deploy the app
    -->
    <target name="preDeploy">
        <echo level="info">Deploy settings needed for the initial source deploy to: ${sf.target.username} to run successfully</echo>
        <delete dir="${basedir}/pre_deploy"/>
        <mkdir dir="${basedir}/pre_deploy/settings"/>
        <copy file="${basedir}/src/settings/Name.settings" tofile="${basedir}/pre_deploy/settings/Name.settings" encoding="UTF-8"/>
        <echo level="info">Deploying Name settings to: ${sf.target.username}</echo>
        <echo file="${basedir}/pre_deploy/package.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
    <types>
        <members>Name</members>
        <name>Settings</name>
    </types>
        <version>40.0</version>
</Package>]]></echo>
        <sf:deploy
            username="${sf.target.username}"
            password="${sf.target.password}"
            serverurl="${sf.target.serverurl}"
            deployRoot="${basedir}/pre_deploy"
            pollWaitMillis="${sf.pollWaitMillis}"
            maxPoll="${sf.maxPoll}"
            testLevel="NoTestRun"
            logType="Debugonly"/>
        <delete dir="${basedir}/pre_deploy"/>
    </target>

    <target name="turnOffHistoryTracking">
        <echo message="Turn off history tracking in all objects"/>
        <replace dir="${basedir}/src/objects">
            <replacetoken><![CDATA[<trackHistory>true</trackHistory>]]></replacetoken>
            <replacevalue><![CDATA[<trackHistory>false</trackHistory>]]></replacevalue>
            <include name="*.object"/>
        </replace>
    </target>

    <target name="removeSironoCallCenterApp">
        <echo message="Hide Sirono_Call_Center.app and remove Sirono_Call_Center from the apps in package.xml"/>
        <replace dir="${basedir}/src/">
            <replacetoken><![CDATA[<members>Sirono_Call_Center</members>]]></replacetoken>
            <replacevalue><![CDATA[]]></replacevalue>
            <include name="package.xml"/>
        </replace>

        <move file="${basedir}/src/applications/Sirono_Call_Center.app"
              tofile="${basedir}/src/applications/Sirono_Call_Center.app.bak"/>
    </target>
    <!--
        We can't deploy objects with history tracking turned on until the objects
        that they reference are deployed; turn off history tracking across the board.

        We can't deploy the Sirono_Call_Center.app until the Sirono User.profile is available, so
        hide it for initial deploy
    -->
    <target name="deployPrep">
        <echo level="info">Perform prep on source in order to deploy to: ${sf.target.username}</echo>
        <antcall target="turnOffHistoryTracking"/>
        <antcall target="removeSironoCallCenterApp"/>
    </target>


    <!--
        Use git to revert the sweeping history tracking changes we made (too hard to try to do any other way).
        Remove the backup copies of other metadata made to 'hide' them
    -->
    <target name="revertPrep">
        <echo message="Revert all changes made in deployPrep"/>
        <exec dir="${basedir}/src/objects" executable="git">
            <arg value="checkout"/>
            <arg value="--"/>
            <arg value="${basedir}/src"/>
        </exec>
        <delete>
            <fileset dir="${basedir}/src" includes="**/*.bak"/>
        </delete>
    </target>

</project>
