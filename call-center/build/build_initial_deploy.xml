<!--
  ~ Copyright (c) 2017-present Sirono LLC, All rights reserved
  -->

<project name="init" default="help"
         xmlns:sf="antlib:com.salesforce"
         xmlns:ml="org.missinglink.ant.task.http.HttpClientTask">

    <target name="help">
        <echo message="Tasks to run for the initial deploy to a Dev org"/>
    </target>

    <!--
        Deploy just the settings needed in order to deploy the app
    -->
    <target name="preDeploy">
        <echo level="info">Deploy settings needed for the initial source deploy to: ${sf.target.username} to run successfully</echo>
        <delete dir="${basedir}/pre_deploy"/>
        <mkdir dir="${basedir}/pre_deploy/settings"/>
        <copy file="${basedir}/src/settings/Name.settings" tofile="${basedir}/pre_deploy/settings/Name.settings" encoding="UTF-8"/>
        <echo level="info">Deploying Name settings to: ${sf.target.username}</echo>
        <echo file="${basedir}/pre_deploy/package.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
    <types>
        <members>Name</members>
        <name>Settings</name>
    </types>
        <version>40.0</version>
</Package>]]></echo>
        <sf:deploy
            username="${sf.target.username}"
            password="${sf.target.password}"
            serverurl="${sf.target.serverurl}"
            deployRoot="${basedir}/pre_deploy"
            pollWaitMillis="${sf.pollWaitMillis}"
            maxPoll="${sf.maxPoll}"
            testLevel="NoTestRun"
            logType="Debugonly"/>
        <delete dir="${basedir}/pre_deploy"/>
    </target>

    <target name="turnOffHistoryTracking">
        <echo message="Turn off history tracking in all objects"/>
        <replace dir="${basedir}/src/objects">
            <replacetoken><![CDATA[<trackHistory>true</trackHistory>]]></replacetoken>
            <replacevalue><![CDATA[<trackHistory>false</trackHistory>]]></replacevalue>
            <include name="*.object"/>
        </replace>
    </target>

    <target name="processTemplates" depends="createSironoNamedCreds"/>

    <target name="createSironoNamedCreds">
        <mkdir dir="${basedir}/src/namedCredentials"/>
        <copy todir="${basedir}/src/namedCredentials" overwrite="true" encoding="UTF-8">
            <fileset dir="${basedir}/template/namedCredentials"/>
        </copy>

        <echo message="Set ${sirono.endpoint} as the Sirono_Server NamedCredential endpoint"/>
        <replace dir="${basedir}/src/namedCredentials" token="@ENDPOINT@" value="${sirono.endpoint}" encoding="UTF-8">
            <include name="sirono_server.namedCredential"/>
        </replace>

        <echo message="Set username and password for Sirono_Server NamedCredential"/>
        <replace dir="${basedir}/src/namedCredentials" token="@USERNAME@" value="${sirono.user}" encoding="UTF-8">
            <include name="sirono_server.namedCredential"/>
        </replace>
        <replace dir="${basedir}/src/namedCredentials" token="@PASSWORD@" value="${sirono.pw}" encoding="UTF-8">
            <include name="sirono_server.namedCredential"/>
        </replace>
    </target>

    <!--
        We can't deploy the sharing rules or deploy objects with history tracking turned on until the objects
        that they reference are deployed. Turn off history tracking across the board & hide the sharing rules
    -->
    <target name="deployPrep">
        <echo level="info">Perform prep on source in order to deploy to: ${sf.target.username}</echo>
        <antcall target="turnOffHistoryTracking"/>
    </target>

    <!--
        Use git to revert the sweeping history tracking changes we made.
        Remove the backup copies of the sharing rules
    -->
    <target name="revertPrep">
        <echo message="Revert all changes made in deployPrep"/>
        <exec dir="${basedir}/src/objects" executable="git">
            <arg value="checkout"/>
            <arg value="--"/>
            <arg value="${basedir}/src"/>
        </exec>
        <delete>
            <fileset dir="${basedir}/src" includes="**/*.bak"/>
        </delete>
    </target>

</project>
